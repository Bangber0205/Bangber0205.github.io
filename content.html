<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wavy | Peringatan Dini Megathrust</title>
    <link rel="stylesheet" href="assets/style3.css">
    <link rel="icon" href="assets/images/cloudy.png">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
</head>
<body>
    <nav>
        <section class="logo-nav">
            <img src="assets/images/cloudy.png" alt="Logo Wavy">
        </section>
        <section class="navbar">
            <div class="cuaca">
                <img src="assets/images/earthquake.png" alt="">
                <a href="home.html"><p>Info Gempa</p></a>
            </div>
            <div class="bencana">
                <img src="assets/images/healthy.png" alt="">
                <p>Jalur Evakuasi</p>
            </div>
            <div class="footer">
                <img src="assets/images/emergency-call.png" alt="">
                <a href=""><p>PANGGILAN DARURAT</p></a>
            </div>
            <div class="wm">
                <p>© 2025 Wavy.co.id</p>
            </div>
        </section>
    </nav>

    <main>
        <div class="manual-input" style="padding:10px; background:rgba(0,59,70,0.85); color:white; border-radius:8px; margin:15px auto; max-width:800px;">
            <h2>Masukkan Titik Awal Manual</h2>
            <input type="text" id="lokasiInput" placeholder="Masukkan nama jalan atau lokasi" style="width:100%; padding:8px; border:none; border-radius:5px; background:rgba(255,255,255,0.15); color:white;">
            <button id="setStartBtn" style="margin-top:8px; width:100%; padding:10px; background:rgb(9,243,216); border:none; border-radius:5px; font-weight:bold; cursor:pointer;">Set Titik Awal</button>
            <p style="font-size:0.85rem; margin-top:5px;">Klik pada peta untuk memilih titik awal secara langsung.</p>
        </div>

        <div id="map"></div>

        <section class="direction" id="direction">
            <h1>Jalur Evakuasi yang Tersedia :</h1>
            <select name="jalur" id="jalurSelect">
                <option value="">-- Pilih Jalur Evakuasi --</option>
                <option value="alun-alun">Alun-Alun</option>
                <option value="politeknik">Politeknik Negeri Cilacap</option>
                <option value="masjid-agung-darussalam">Masjid Agung Darussalam</option>
            </select>
            <div id="infoBox" class="info" style="display: none;"></div>
        </section>
    </main>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.min.js"></script>

    <script>
const jalurData = {
    "alun-alun": {
        nama: "Alun-Alun Cilacap",
        arah: "Utara",
        koordinat: [-7.72837, 109.0098], // diperbaiki & akurat
        jarak: "±1.5 km",
        keterangan: "Tempat terbuka luas, aman dari reruntuhan."
    },
    "politeknik": {
        nama: "Politeknik Negeri Cilacap",
        arah: "Timur Laut",
        koordinat: [-7.7258408, 109.0169772], // diperbaiki
        jarak: "±2.0 km",
        keterangan: "Lokasi aman dan dekat dengan tim SAR."
    },
    "masjid-agung-darussalam": {
        nama: "Masjid Agung Darussalam Cilacap",
        arah: "Tengah Kota",
        koordinat: [-7.728, 109.010], // diperbaiki dari yang sangat jauh sebelumnya
        jarak: "±1.0 km",
        keterangan: "Dekat pusat kota dan memiliki struktur bangunan kuat."
    }
};


const map = L.map('map').setView([-7.740532, 109.012283], 14);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap'
}).addTo(map);

const selectElement = document.getElementById("jalurSelect");
const infoBox = document.getElementById("infoBox");

let control = null;
let startPoint = [-7.740532, 109.012283];
let startMarker = L.marker(startPoint).addTo(map).bindPopup('Titik Awal').openPopup();

function hitungJarak(coord1, coord2) {
    const R = 6371;
    const dLat = (coord2[0] - coord1[0]) * Math.PI / 180;
    const dLon = (coord2[1] - coord1[1]) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(coord1[0] * Math.PI / 180) * Math.cos(coord2[0] * Math.PI / 180) *
              Math.sin(dLon/2) * Math.sin(dLon/2);
    return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
}

function pilihJalurTerdekat() {
    let terdekat = null;
    let jarakMin = Infinity;
    for (let key in jalurData) {
        let jarak = hitungJarak(startPoint, jalurData[key].koordinat);
        if (jarak < jarakMin) {
            jarakMin = jarak;
            terdekat = key;
        }
    }
    if (terdekat) {
        selectElement.value = terdekat;
        selectElement.dispatchEvent(new Event('change'));
    }
}

function setLokasi(lat, lon, sumber = "GPS") {
    startPoint = [lat, lon];
    startMarker.setLatLng(startPoint)
        .bindPopup(`Titik Awal (${sumber})`)
        .openPopup();
    map.setView(startPoint, 15);
    pilihJalurTerdekat();
}

function getLokasiIP() {
    fetch('https://ipapi.co/json/')
        .then(res => res.json())
        .then(data => {
            if (data.latitude && data.longitude) {
                alert("Lokasi GPS tidak tersedia. Menggunakan lokasi berdasarkan IP (perkiraan).");
                setLokasi(data.latitude, data.longitude, "IP (Perkiraan)");
            } else {
                alert("Tidak dapat mendeteksi lokasi dari IP.");
            }
        })
        .catch(() => {
            alert("Gagal mendapatkan lokasi dari IP.");
        });
}

function deteksiLokasiOtomatis() {
    if (!navigator.geolocation) {
        alert("Browser Anda tidak mendukung fitur GPS. Menggunakan lokasi IP.");
        getLokasiIP();
        return;
    }

    navigator.geolocation.getCurrentPosition(
        (pos) => {
            setLokasi(pos.coords.latitude, pos.coords.longitude, "GPS");
        },
        (err) => {
            console.warn("Gagal mendapatkan lokasi GPS:", err);
            switch (err.code) {
                case err.PERMISSION_DENIED:
                    alert("Akses lokasi ditolak. Menggunakan lokasi dari IP.");
                    break;
                case err.POSITION_UNAVAILABLE:
                    alert("Informasi lokasi tidak tersedia.");
                    break;
                case err.TIMEOUT:
                    alert("Waktu permintaan lokasi habis. Menggunakan lokasi IP.");
                    break;
                default:
                    alert("Terjadi kesalahan saat mengambil lokasi.");
            }
            getLokasiIP();
        },
        {
            enableHighAccuracy: true,
            timeout: 15000,
            maximumAge: 0
        }
    );
}

window.addEventListener("load", deteksiLokasiOtomatis);

// Input manual
document.getElementById("setStartBtn").addEventListener("click", () => {
    const lokasi = document.getElementById("lokasiInput").value;
    if (lokasi.trim() === "") {
        alert("Masukkan nama jalan atau lokasi!");
        return;
    }
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(lokasi)}`)
        .then(response => response.json())
        .then(data => {
            if (data.length > 0) {
                const lat = parseFloat(data[0].lat);
                const lon = parseFloat(data[0].lon);
                setLokasi(lat, lon, lokasi);
            } else {
                alert("Lokasi tidak ditemukan!");
            }
        })
        .catch(err => {
            console.error(err);
            alert("Terjadi kesalahan saat mencari lokasi.");
        });
});

// Klik peta untuk set titik awal
map.on('click', function(e) {
    setLokasi(e.latlng.lat, e.latlng.lng, "Klik Peta");
});

// Ganti jalur evakuasi
selectElement.addEventListener("change", function () {
    const value = this.value;
    if (jalurData[value]) {
        const data = jalurData[value];
        infoBox.style.display = "block";
        infoBox.innerHTML = `
            <h2>Informasi Jalur : ${data.nama}</h2>
            <p><strong>Arah :</strong> ${data.arah}</p>
            <p><strong>Koordinat :</strong> ${data.koordinat[0]}, ${data.koordinat[1]}</p>
            <p><strong>Jarak :</strong> ${data.jarak}</p>
            <p><strong>Keterangan :</strong> ${data.keterangan}</p>
        `;
        if (control !== null) {
            map.removeControl(control);
        }
        control = L.Routing.control({
            waypoints: [
                L.latLng(startPoint),
                L.latLng(data.koordinat)
            ],
            routeWhileDragging: false
        }).addTo(map);
    } else {
        infoBox.style.display = "none";
        infoBox.innerHTML = "";
        if (control !== null) {
            map.removeControl(control);
            control = null;
        }
    }
});
</script>
</body>
</html>
